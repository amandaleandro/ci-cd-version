on:
    workflow_run:
      workflows: ["Docker Build & Push"]
      types:
        - completed
env:
    EMAIL: ${{ secrets.EMAIL }}
    DOMAIN: ${{ secrets.DOMAIN }}
    
jobs:
    helm-deployments:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
  
        - name: Read Docker image name
          id: read_image_name
          run: |
            IMAGE_NAME=$(cat docker_image_name.txt)
            echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          continue-on-error: false
  
        - name: Prepare Helm chart
          run: |
            rm -rf ./kubernetes/values.yaml
            envsubst < ./kubernetes/helm.yaml > ./kubernetes/values.yaml
          env:
            REPLICAS: 1
            EMAIL: ${{ env.EMAIL }}
            DOMAIN: ${{ env.DOMAIN }}
            DOCKER_IMG: ${{ env.IMAGE_NAME }}
            BUILD_VERSION: ${{ env.IMAGE_NAME }}
            BUILD_ID: "${{ github.run_id }}-${{ github.run_number }}"
  
        - name: Deploy ${{ env.IMAGE_NAME }}
          uses: WyriHaximus/github-action-helm3@v2
          with:
            exec: |
              helm repo add $HELM_NAME $HELM_REP --force-update
              helm fetch $HELM_CHART --version $HELM_VERSION
              helm upgrade $K8S_APP $HELM_CHART --install --wait --create-namespace --namespace $K8S_NAMESPACE --values $K8S_VALUES
          env:
            HELM_REP: ""
            HELM_NAME: ""
            HELM_CHART: ""
            HELM_VERSION: ""
            K8S_NAMESPACE: ""
            K8S_APP: ""
            K8S_VALUES: ./kubernetes/values.yaml
            kubeconfig: '${{ secrets.KUBECONFIG }}'
  
        - name: Write to workflow job summary
          run: |
            echo "# Whats app front control" >> summary
            echo "🎉 🍻 version ${{ env.IMAGE_NAME }} ✅" >> summary
            cat summary >> $GITHUB_STEP_SUMMARY